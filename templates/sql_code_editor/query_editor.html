{% extends "base.html" %}

{% block content %}
<div class="query-editor-container">
    <h1>SQL Playground</h1>
    <p>Practice SQL queries with real datasets. No restrictions, just learning!</p>
    
    <div class="editor-layout">
        <!-- Left Panel - Schema Browser -->
        <div class="schema-panel">
            <div class="dataset-selector">
                <label for="dataset-select">Choose a dataset:</label>
                <select id="dataset-select">
                    {% for dataset in datasets %}
                    <option value="{{ dataset.id }}">{{ dataset.name }} ({{ dataset.difficulty }})</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="schema-viewer">
                <h3>Schema</h3>
                <div id="schema-content">
                    <!-- Schema will be loaded dynamically -->
                </div>
            </div>
            
            <div class="sample-data">
                <h3>Sample Data</h3>
                <div id="sample-data-content">
                    <!-- Sample data will be loaded dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Main Editor Area -->
        <div class="editor-area">
            <div class="editor-header">
                <div class="editor-actions">
                    <button id="execute-btn" class="btn">Execute</button>
                    <button id="format-btn" class="btn">Format SQL</button>
                    <button id="explain-btn" class="btn">Explain</button>
                    <button id="save-btn" class="btn">Save Query</button>
                </div>
            </div>
            
            <div id="editor" class="monaco-editor"></div>
            
            <!-- Result Tabs -->
            <div class="result-tabs">
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#results-tab" data-toggle="tab">Results</a></li>
                    <li><a href="#performance-tab" data-toggle="tab">Performance</a></li>
                    <li><a href="#plan-tab" data-toggle="tab">Execution Plan</a></li>
                    <li><a href="#feedback-tab" data-toggle="tab">AI Feedback</a></li>
                </ul>
                
                <div class="tab-content">
                    <!-- Results Tab -->
                    <div class="tab-pane active" id="results-tab">
                        <div class="result-stats">
                            <span id="row-count">0 rows</span>
                            <span id="execution-time">0 ms</span>
                        </div>
                        <div id="result-table-container">
                            <table id="result-table">
                                <thead>
                                    <tr id="result-headers"></tr>
                                </thead>
                                <tbody id="result-body"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Performance Tab -->
                    <div class="tab-pane" id="performance-tab">
                        <div class="performance-metrics">
                            <div class="metric">
                                <span class="metric-label">Performance Score:</span>
                                <span id="performance-score" class="metric-value">0/100</span>
                                <div class="progress">
                                    <div id="performance-bar" class="progress-bar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div id="optimization-suggestions"></div>
                        </div>
                    </div>
                    
                    <!-- Execution Plan Tab -->
                    <div class="tab-pane" id="plan-tab">
                        <div id="visual-plan" class="plan-visualization">
                            <!-- Visual plan will be rendered here -->
                        </div>
                        <pre id="raw-plan"></pre>
                    </div>
                    
                    <!-- AI Feedback Tab -->
                    <div class="tab-pane" id="feedback-tab">
                        <div id="ai-feedback-content">
                            <!-- AI feedback will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Error Panel -->
    <div id="error-panel" class="alert alert-danger" style="display: none;">
        <h4>Error</h4>
        <div id="error-message"></div>
        <div id="error-details"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Monaco Editor
    const editor = monaco.editor.create(document.getElementById('editor'), {
        value: "SELECT * FROM data LIMIT 10;",
        language: 'sql',
        theme: '{{ editor_config.theme }}',
        fontSize: {{ editor_config.font_size }},
        minimap: { enabled: false }
    });
    
    // Current dataset
    let currentDatasetId = document.getElementById('dataset-select').value;
    
    // Load schema and sample data for initial dataset
    loadSchema(currentDatasetId);
    loadSampleData(currentDatasetId);
    
    // Dataset selector change event
    document.getElementById('dataset-select').addEventListener('change', function() {
        currentDatasetId = this.value;
        loadSchema(currentDatasetId);
        loadSampleData(currentDatasetId);
    });
    
    // Execute button
    document.getElementById('execute-btn').addEventListener('click', executeQuery);
    
    // Format button
    document.getElementById('format-btn').addEventListener('click', function() {
        const formatted = formatSql(editor.getValue());
        editor.setValue(formatted);
    });
    
    // Explain button
    document.getElementById('explain-btn').addEventListener('click', explainQuery);
    
    // Save button
    document.getElementById('save-btn').addEventListener('click', saveQuery);
    
    // Function to load schema
    function loadSchema(datasetId) {
        fetch(`/api/datasets/${datasetId}/`)
        .then(response => response.json())
        .then(data => {
            const schemaContent = document.getElementById('schema-content');
            let html = '';
            
            if (data.schema && data.schema.tables) {
                data.schema.tables.forEach(table => {
                    html += `<div class="table-schema">`;
                    html += `<h4>${table.name}</h4>`;
                    html += `<ul>`;
                    table.columns.forEach(column => {
                        html += `<li><strong>${column.name}</strong>: ${column.type}</li>`;
                    });
                    html += `</ul>`;
                    html += `</div>`;
                });
            }
            
            schemaContent.innerHTML = html || '<p>No schema available</p>';
        });
    }
    
    // Function to load sample data
    function loadSampleData(datasetId) {
        fetch(`/api/datasets/${datasetId}/`)
        .then(response => response.json())
        .then(data => {
            const sampleContent = document.getElementById('sample-data-content');
            let html = '';
            
            if (data.sample_data && Object.keys(data.sample_data).length > 0) {
                for (const [table, rows] of Object.entries(data.sample_data)) {
                    html += `<div class="table-sample">`;
                    html += `<h4>${table} (${rows.length} rows)</h4>`;
                    
                    if (rows.length > 0) {
                        const headers = Object.keys(rows[0]);
                        html += `<div class="table-responsive"><table class="table table-sm">`;
                        html += `<thead><tr>`;
                        headers.forEach(header => {
                            html += `<th>${header}</th>`;
                        });
                        html += `</tr></thead>`;
                        html += `<tbody>`;
                        
                        rows.slice(0, 5).forEach(row => {
                            html += `<tr>`;
                            headers.forEach(header => {
                                html += `<td>${row[header]}</td>`;
                            });
                            html += `</tr>`;
                        });
                        
                        html += `</tbody></table></div>`;
                    }
                    
                    html += `</div>`;
                }
            }
            
            sampleContent.innerHTML = html || '<p>No sample data available</p>';
        });
    }
    
    // Function to execute query
    function executeQuery() {
        const query = editor.getValue();
        const datasetId = document.getElementById('dataset-select').value;
        
        // Show loading state
        document.getElementById('execute-btn').disabled = true;
        document.getElementById('execute-btn').textContent = 'Executing...';
        
        fetch("{% url 'execute_playground_query' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                query: query,
                dataset_id: datasetId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display results
                displayResults(data);
                
                // Display performance metrics
                if (data.performance) {
                    displayPerformance(data.performance);
                }
                
                // Clear errors
                document.getElementById('error-panel').style.display = 'none';
            } else {
                // Display error
                displayError(data);
            }
        })
        .catch(error => {
            displayError({ error: 'An unexpected error occurred', error_details: error.message });
        })
        .finally(() => {
            // Reset button state
            document.getElementById('execute-btn').disabled = false;
            document.getElementById('execute-btn').textContent = 'Execute';
        });
    }
    
    // Function to display results
    function displayResults(data) {
        const tableHead = document.getElementById('result-headers');
        const tableBody = document.getElementById('result-body');
        
        // Clear previous results
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';
        
        // Update stats
        document.getElementById('row-count').textContent = `${data.row_count} rows`;
        document.getElementById('execution-time').textContent = `${data.execution_time} ms`;
        
        // Add headers
        data.columns.forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            tableHead.appendChild(th);
        });
        
        // Add rows
        data.data.forEach(row => {
            const tr = document.createElement('tr');
            data.columns.forEach(col => {
                const td = document.createElement('td');
                td.textContent = row[col] !== null ? row[col] : 'NULL';
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
        
        // Switch to results tab
        document.querySelector('[href="#results-tab"]').click();
    }
    
    // Function to display performance metrics
    function displayPerformance(performance) {
        document.getElementById('performance-score').textContent = 
            `${performance.performance_score}/100`;
        
        const performanceBar = document.getElementById('performance-bar');
        performanceBar.style.width = `${performance.performance_score}%`;
        
        // Set color based on score
        if (performance.performance_score >= 80) {
            performanceBar.className = 'progress-bar progress-bar-success';
        } else if (performance.performance_score >= 60) {
            performanceBar.className = 'progress-bar progress-bar-warning';
        } else {
            performanceBar.className = 'progress-bar progress-bar-danger';
        }
        
        // Display optimization suggestions
        let suggestionsHtml = '<h4>Optimization Suggestions</h4><ul>';
        performance.optimization_suggestions.forEach(suggestion => {
            suggestionsHtml += `<li>${suggestion}</li>`;
        });
        suggestionsHtml += '</ul>';
        
        document.getElementById('optimization-suggestions').innerHTML = suggestionsHtml;
    }
    
    // Function to explain query
    function explainQuery() {
        const query = editor.getValue();
        const datasetId = document.getElementById('dataset-select').value;
        
        fetch("{% url 'explain_query' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                query: query,
                dataset_id: datasetId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('ai-feedback-content').textContent = data.explanation;
                document.querySelector('[href="#feedback-tab"]').click();
            } else {
                displayError(data);
            }
        });
    }
    
    // Function to display error
    function displayError(data) {
        document.getElementById('error-message').textContent = data.error;
        
        let details = '';
        if (data.error_details) {
            details = '<ul>';
            data.error_details.forEach(detail => {
                details += `<li>${detail.message}</li>`;
            });
            details += '</ul>';
        }
        document.getElementById('error-details').innerHTML = details;
        
        document.getElementById('error-panel').style.display = 'block';
    }
    
    // Function to save query
    function saveQuery() {
        const query = editor.getValue();
        const datasetId = document.getElementById('dataset-select').value;
        
        // In a real implementation, this would save to the database
        alert('Query saved! (Implementation would save to your profile)');
    }
    
    // Simple SQL formatter
    function formatSql(sql) {
        // This is a placeholder - in a real project, use a library like sql-formatter
        return sql
            .replace(/SELECT/g, '\nSELECT')
            .replace(/FROM/g, '\nFROM')
            .replace(/WHERE/g, '\nWHERE')
            .replace(/GROUP BY/g, '\nGROUP BY')
            .replace(/ORDER BY/g, '\nORDER BY');
    }
});
</script>
{% endblock %}